---
title: "Coupled predator-prey models and its application in investing in stock market"
author: "Aurél György Prósz, XGRP0J"
date: '2018 október 9 '
output: 
  pdf_document:
    toc: true  

---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```
# Introduction

Predator-prey models are important topics not only in biology, but in other fields like plasma physics[http://iopscience.iop.org/article/10.1088/0741-3335/56/1/015002], economics[https://www.sciencedirect.com/science/article/pii/0895717794900124], or even in criminology [https://www.ncbi.nlm.nih.gov/pmc/articles/PMC5043299/].  
The first, simplest model originated from the study of fish populations of the Mediterranean after the first world war, by Lotka and Volterra. In their model there are two types of species: the prey, and the predator. They form a simple food-chain where the predator species hunts the prey species, while the prey grazes vegetation. Their behavior and the time evolution of the number of species are characterized by a simple system of two, nonlinear first order differential equations. By solving these equations we can have insights on how the number of predators and preys evolve in time.  
In this document I present the classical Lotka-Volterra (LV) equations and its modified versions. I also reproduce a financial model described in [https://ijpam.eu/contents/2016-107-2/17/17.pdf], which can be used by a stock market trader to eliminate some of its risks involving the trading of specific stocks by buying the shares of so called prey companies, and sell them to a predator company.

# Project goals

Implement and interpret the:  

* Classical LV model
* Classical LV model at equilibrium
* LV model with prey hill function and LV model with predator efficiency
* LV model with one predator - two preys without interaction between the preys
* LV model used in stock market

## My own contribution to the topic

The first three models are discussed in the [willeybook] already, but was implemented in Python. My own contribution to these tasks is to recreate them using R and its DeSolve library and to validate my further results.  
The one predator - two preys model was discussed in [] and [], but with an interaction term included between the preys, so I found it interesting if I can analyze the results without the interactions.

# Materials and methods
## R programming language
R is a language and environment for statistical computing and graphics. It is a GNU project which is similar to the S language and environment which was developed at Bell Laboratories (formerly AT&T, now Lucent Technologies) by John Chambers and colleagues. R provides a wide variety of statistical (linear and nonlinear modelling, classical statistical tests, time-series analysis, classification, clustering, …) and graphical techniques, and is highly extensible. 


## DeSolve library

R package deSolve is the successor of R package odesolve, which is a package to solve initial value problems (IVP) of ordinary differential equations (ODE), differential algebraic equations (DAE), partial differential equations (PDE), and delay differential equations (DeDE). I used this package to solve the systems of nonlinear differential equations present in predator-prey models.  
The particular function I used for the solutions is the *lsoda* function [].

## Possible source of errors



# Classical LV model

This model describes the interaction of a predatory and a prey species. The predators try to catch the preys, thus increasing their population, and decreasing the prey’s. In this model the prey species has unlimited resources to feed, and in this way the population of the prey species grows exponentially if no predatory species are present. We can summarize the whole model in a system of nonlinear differential equations:
$$
\frac{dX}{dt}= aX-bXY
$$
$$
\frac{dY}{dt}= bkXY-lY
$$
where *x* and *y* are the prey and predator density, respectively, *a* and *l* determines how fast the preys reproduce and the predators die of hunger. *b* and *k* describes the interaction part of the equation, where *b* governs the interaction rate between the two species, and *k* is set the efficiency of which the predators converts prey to food.


```{r, echo=FALSE, warning=FALSE, message=FALSE}
library(deSolve)
library(ggplot2)
library(reshape2)
library(gridExtra)



model_system <- function(model, Pars, State, grouped){
  out <- as.data.frame(ode(func = model, y = State, parms = Pars, times = Time))
  out.r <- within(out, rm(time))
  out.m <- melt(out.r)
  out.m$time <- out$time
  if (grouped == TRUE){
  return(out.m)
  }
  else{
    return(out)
  }
}

LotVmod_classical <- function (Time, State, Pars) {
    with(as.list(c(State, Pars)), {
        dx = x*(alpha - beta*y)
        dy = delta*x*y - gamma*y
        return(list(c(dx, dy)))
    })
}
 
Pars <- c(alpha = 0.1, beta = 0.02, gamma = 0.4, delta = 0.02)
State <- c(x = 10, y = 10)
Time <- seq(0, 200, by = 0.1)
 
out.m <- model_system(LotVmod_classical, c(alpha = 0.1, beta = 0.02, gamma = 0.4, delta = 0.02), 
                      c(x = 10, y = 10), TRUE)
out1 <- model_system(LotVmod_classical, c(alpha = 0.1, beta = 0.02, gamma = 0.4, delta = 0.02), 
                      c(x = 10, y = 10), FALSE)
out2 <- model_system(LotVmod_classical, c(alpha = 0.1, beta = 0.02, gamma = 0.4, delta = 0.02), 
                      c(x = 50, y = 10), FALSE)
out3 <- model_system(LotVmod_classical, c(alpha = 0.1, beta = 0.02, gamma = 0.4, delta = 0.02), 
                      c(x = 200, y = 10), FALSE)

out1$preystart <- 10
out2$preystart <- 50
out3$preystart <- 200


out.final <- rbind(out1,out2,out3)
out.final$preystart <- as.factor(out.final$preystart)
p1<-ggplot(out.m, aes(x=time, y=value, color=variable)) +
  geom_line(aes(color=variable), size = 1)+
  
  labs(x = "Time",
       y = "Species density",
       color = "Species",
       title = "Time evolution of the prey and predator densities") +
   theme(plot.title = element_text(size=8)) + theme(legend.position="bottom",legend.direction="horizontal")


p2<-ggplot(out.final, aes(x=x, y=y, color = preystart))+
  geom_point(aes(color=preystart), size = 0.05)+ 
  labs(x = "Prey density",
       y = "Predator density",
       color = "Prey initial number",
       title = "Phase space of prey and predator densities")  +
   theme(plot.title = element_text(size=8)) + theme(legend.position="bottom",legend.direction="horizontal")

grid.arrange(p1, p2, ncol=2)
```


```{r, echo=FALSE, warning=FALSE, message=FALSE}
out.m <- model_system(LotVmod_classical, c(alpha = 0.1, beta = 0.02, gamma = 0.4, delta = 0.02), 
                      c(x = 20, y = 5), TRUE)
out <- model_system(LotVmod_classical, c(alpha = 0.1, beta = 0.02, gamma = 0.4, delta = 0.02), 
                      c(x = 20, y = 5), FALSE)

p3<-ggplot(out.m, aes(x=time, y=value, group=variable)) +
  geom_line(aes(color=variable), size = 1)+
  
  labs(x = "Time",
       y = "Species density",
       title = "Time evolution of the prey and predator densities in the steady state")+ theme(legend.position="bottom",legend.direction="horizontal")+
   theme(plot.title = element_text(size=8))

p4<-ggplot(out, aes(x=x, y=y))+
  geom_point()+ 
  labs(x = "Prey density",
       y = "Predator density",
       title = "Phase space of prey and predator densities in the steady state") + theme(legend.position="bottom",legend.direction="horizontal")+
   theme(plot.title = element_text(size=8))


grid.arrange(p3, p4, ncol=2)
```



## Discussion  

On plot1 one can see that the solution of this model is an oscillatory behavior, where the prey and predator density rise and fall out of phase respect to each other.Plotting the x,y phase space on plot2 shows closed orbits, called limit cycles. However, the orbits are not perfectly closed due to the errors in the numerical integration of the equations.


# LV model with prey limit and predator efficiency

This model extends the classical LV model in such a way, that it includes a so called K carrying capacity for the prey population, and a functional response palpha, as the probability a predator finds one prey. These two parameters makes the model more realistic, as in reality the resources available for the preys are not unlimited, and the hunt by the predators are not always successful, and takes time. 
$$
\frac{dX}{dt} = Xa(1-\frac{X}{K}) - \frac{bYX}{1+bX\tau}
$$
$$
\frac{dY}{dt}= bkXY-lY
$$

```{r, echo=FALSE, warning=FALSE, message=FALSE}
LotVmod_version2 <- function (Time, State, Pars) {
    with(as.list(c(State, Pars)), {
        dx = x*alpha*(1-x/K) - (beta*y*x)/(1+beta*x*tau)
        dy = delta*x*y - gamma*y
        return(list(c(dx, dy)))
    })
}
 

Time <- seq(0, 500, by = 0.1)
 
out.m <- model_system(LotVmod_version2, c(alpha = 0.1, beta = 0.02, gamma = 0.4, delta = 0.02, K = 100, tau = 0.3), 
                      c(x = 10, y = 10), TRUE)
out <- model_system(LotVmod_version2, c(alpha = 0.1, beta = 0.02, gamma = 0.4, delta = 0.02, K = 100, tau = 0.3), 
                      c(x = 10, y = 10), FALSE)

p1<-ggplot(out.m, aes(x=time, y=value, group=variable)) +
  geom_line(aes(color=variable))+
  geom_point(aes(color=variable)) + 
  labs(x = "Time",
       y = "Species density",
       title = "Time evolution of the prey and predator densities")

p1

p2<-ggplot(out, aes(x=x, y=y))+
  geom_point(aes(color="red"))+ 
  labs(x = "Prey density",
       y = "Predator density",
       title = "Phase space of prey and predator densities")
p2
```


 Equation
Source of errors
Pictures

# Two preys, one predator LV model

This modification of the original LV model includes the extensions mentioned above, and also includes one more prey species. In reality there can be preys which can be hunted down more easily by the predator, and could have different carrying capacity. These biological information are included in the parameters of this model. 

$$
\frac{dX_{1}}{dt} = Xa_{1}(1-\frac{X_{1}}{K_{1}}) - \frac{b_{1}YX_{1}}{1+b_{1}X_{1}\tau_{1}}

$$
$$
\frac{dX_{2}}{dt} = Xa_{2}(1-\frac{X_{2}}{K_{2}}) - \frac{b_{2}YX_{2}}{1+b_{2}X_{2}\tau_{2}}
$$

$$
\frac{dY}{dt}= \delta X_{1}Y + \delta X_{2}Y-lY
$$

```{r, echo=FALSE, warning=FALSE, message=FALSE}
LotVmod_twoprey <- function (Time, State, Pars) {
    with(as.list(c(State, Pars)), {
        
        dx1 = x1*alpha1*(1-x1/K1) - (beta1*y*x1)/(1+beta1*x1*tau1) 
        dx2 = x2*alpha2*(1-x2/K2) - (beta2*y*x2)/(1+beta2*x2*tau2)
        dy = delta1*x1*y + delta2*x2*y - gamma*y
        return(list(c(dx1,dx2 ,dy)))
    })
}
 

Time <- seq(0, 500, by = 0.1)
 
out.m <- model_system(LotVmod_twoprey, c(alpha1 = 0.1, beta1 = 0.02, gamma = 0.4, delta1 = 0.02, K1 = 100, tau1 = 0.3,alpha2 = 0.15, beta2 = 0.02, K2 = 100, tau2 = 0.3, delta2 = 0.02, sigma1 = 0.01, sigma2 = 0.01), 
                      c(x1 = 30,x2 = 10 ,y = 10), TRUE)
out <- model_system(LotVmod_twoprey, c(alpha1 = 0.1, beta1 = 0.02, gamma = 0.4, delta1 = 0.02, K1 = 100, tau1 = 0.3,alpha2 = 0.15, beta2 = 0.02, K2 = 100, tau2 = 0.3, delta2 = 0.02, sigma1 = 0.01, sigma2 = 0.01), 
                      c(x1 = 30,x2 = 10 ,y = 10), FALSE)

p1<-ggplot(out.m, aes(x=time, y=value, group=variable)) +
  geom_line(aes(color=variable))+
  geom_point(aes(color=variable)) + 
  labs(x = "Time",
       y = "Species density",
       title = "Time evolution of the prey and predator densities")

p1

p2<-ggplot(out, aes(x=x, y=y))+
  geom_point(aes(color="red"))+ 
  labs(x = "Prey density",
       y = "Predator density",
       title = "Phase space of prey and predator densities")
#p2
```


# Stock market application

Within recent times, application of models which originate from biology have become used in finance to describe the complex behavior of the stock market. There are multiple approaches [] which tries to apply the slightly modified version of the predator-prey models to analyze how venture capital investments exhaust the available stock of opportunities. A trader would be likely to make a more informed choice between competing stocks or shares based on comparisons among prices per share.  
In the model described in this chapter the financially powerful trading company who wants to acquire smaller, financially weak companies, is the predator, while the smaller companies represent the prey. The predator makes a monetary offer for the prey shares. Once purchased, these shares are held until they are converted to predator shares.  
The main objective is to simulate the system described above, and to make profit from the price changes.  
In order for this to be profitable financially, the predator needs to have an
estimate of the risk involved in this trade and this is based on changes in his
predatory share prices.  
Analyzing the simulation results can allow the trader to find the specific parameters which makes the system stable, and this would allow determine if the acquistion of prey company shares is profitable, or not.  
$$
\frac{X_{1}}{dt} = \alpha_{1}X_{1}\left ( 1-\frac{X_{1}}{K_{1}} \right )-m_{12}X_{1}X_{2} - \beta X_{1}Yr_{1}
$$

$$
\frac{X_{2}}{dt} = \alpha_{2}X_{2}\left ( 1-\frac{X_{2}}{K_{2}} \right )-m_{21}X_{1}X_{2} - \beta X_{2}Yr_{2}
$$

$$
\frac{dY}{dt} = -\mu Y + c_{1}\beta_{1}X_{1}Yr_{1} + c_{2}\beta_{2}X_{2}Yr_{2}
$$

$$
r1 = \frac{1}{1+\left ( \frac{a_{2}X_{2}+b_{2}Y}{X_{1}} \right )^{n}}
$$

$$
r2 = \frac{1}{1+\left ( \frac{a_{1}X_{1}+b_{1}Y}{X_{2}} \right )^{n}}
$$

*X1* and *X2* are relative share prices of competing prey companies, *Y* is the relative price per share of the predator company. The parameters used in the model are all non-negative.  
*alpha1* and *alpha2*: Intrinsic growth rate of prey share price,  
*K1* and *K2*: Carrying capacity of prey shares,  
*m12* and *m21*: Inter-specific competition between prey market shares,  
*beta1* and *beta2*: Predatory capture rate  is the probability predator Y invests in prey X1 or X2,  
*a1* and *a2*: Harvesting rate of prey shares,  
*b1* and *b2*: Anti-predator behavior of prey shares,  
*c1* and *c2*: Rate of conversion of prey shares to predator shares,  
*mu*: Rate of decline of predator share price,  
*n* : Multiplicative effect due to the predatory functional response.  





```{r, echo=FALSE, warning=FALSE, message=FALSE}
LotVmod_stock <- function (Time, State, Pars) {
    with(as.list(c(State, Pars)), {
        r1 = 1/((1+(a2*x2+b2*y)^n)/x1)
        r2 = 1/((1+(a1*x1+b1*y)^n)/x2)
        dx1 = x1*alpha1*(1-x1/K1) - m12*x1*x2 - (beta1*y*x1)*r1
        dx2 = x2*alpha2*(1-x2/K2) - m21*x1*x2 -(beta2*y*x2)*r2
        dy = -mu*y + c1*beta1*x1*y*r1 + c2*beta2*x2*y*r2
        return(list(c(dx1,dx2 ,dy)))
    })
}
 

Time <- seq(0, 20000, by = 100)
 
out.m <- model_system(LotVmod_stock, c(alpha1 = 0.04, alpha2 = 0.05,
                      K1 = 5, K2 = 10, m12 = 0.01, m21 = 0.02,beta1 = 0.03, beta2 = 0.03,
                      mu = 0.02, c1 = 0.1, c2 = 0.2, n = 1, a1 = 0.02, a2 =1.5, b1 = 0.01, b2=0.03),c(x1 = 0.5644,x2 = 3.3233 ,y =  0.7406), TRUE)


out <- model_system(LotVmod_stock, c(alpha1 = 0.04, alpha2 = 0.05,
                      K1 = 5, K2 = 10, m12 = 0.01, m21 = 0.02,beta1 = 0.03, beta2 = 0.03,
                      mu = 0.02, c1 = 0.1, c2 = 0.2, n = 1, a1 = 0.02, a2 =1.5, b1 = 0.01, b2=0.03),c(x1 = 0.5644,x2 = 3.3233 ,y =  0.7406), FALSE)

p1<-ggplot(out.m, aes(x=time, y=value, group=variable)) +
  geom_line(aes(color=variable))+
  geom_point(aes(color=variable)) + 
  labs(x = "Time",
       y = "Species density",
       title = "Time evolution of the prey and predator densities")

p1

p2<-ggplot(out, aes(x=x, y=y))+
  geom_point(aes(color="red"))+ 
  labs(x = "Prey density",
       y = "Predator density",
       title = "Phase space of prey and predator densities")
#p2


```

