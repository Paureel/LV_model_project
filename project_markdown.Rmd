---
title: "Coupled predator-prey models and its application in investing in the stock market"
author: "Aurél György Prósz, XGRP0J"
date: October 22, 2018 
output: 
  pdf_document:
    toc: true  
bibliography: bibliography.bib
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```
\newpage

# Motivation

What if we can simulate the complex behaviour and interaction of certain species which compete, or work together? Can we model a food chain with only simple equations? What is the relationship between foxes and rabbits in the forest, and the chaotic nature of the stock market?  
When I choosed this topic I have found fascinating how mechanisms which seemingly do not have very much in common could relate to each other. In the next few pages I present a model and its extension which can describe certain aspects of our world in a new way. 

# Introduction

Predator-prey models are important topics not only in biology, but in other fields like plasma physics[@0741-3335-56-1-015002], economics[@APEDAILLE19941], or even in criminology [@Sooknanan2016AMP].  
The first, simplest model originated from the study of fish populations of the Mediterranean after the first world war, by Lotka and Volterra. In their model there are two types of species: the prey, and the predator. They form a simple food-chain where the predator species hunts the prey species, while the prey grazes vegetation. Their behavior and the time evolution of the number of species are characterized by a simple system of two, nonlinear first order differential equations. By solving these equations we can have insights on how the number of predators and preys evolve in time.  
In this document I present the classical Lotka-Volterra (LV) equations and its modified versions. I also reproduce a financial model described in [@stock], which can be used by a stock market trader to eliminate some of its risks involving the trading of specific stocks by buying the shares of so called prey companies, and sell them to a predator company.

# Project goals

In this project I first implement, evaluate and interpret the simplest of the predator-prey models, and using the results I build more complex models, which can be applied in a financial setting. The following models are going to be investigated:  

* Classical LV model
* Classical LV model at equilibrium
* LV model with prey limit and predation efficiency
* LV model with one predator - two preys without interaction between the preys
* LV model with one predator - two preys, in a financial setting

## My own contribution to the topic

The first three models are discussed in the [@willeybook] already, but was implemented in Python. My own contribution to these tasks is to recreate them using R and its DeSolve library and to validate my further results.  
The one predator - two-prey model was discussed in [@ELETTREBY20092018] and [@comp], but with an interaction term, either synergestic or competitive, included between the preys, so I found it interesting if I can analyze the results without the interactions.  
Last but not least, I recreated the financial model presented in [@stock], and evaluated it at a certain parameter set, which gives a stable, and an unstable result.

# Materials and methods
## R programming language
R is a language and environment for statistical computing and graphics. It is a GNU project which is similar to the S language and environment which was developed at Bell Laboratories (formerly AT&T, now Lucent Technologies) by John Chambers and colleagues. R provides a wide variety of statistical (linear and nonlinear modelling, classical statistical tests, time-series analysis, classification, clustering, …) and graphical techniques, and is highly extensible. 

## ggplot2 library
**ggplot2** is an R library for creating graphics, based on the The Grammar of Graphics. It has been created by Hadley Wickham and is part of the tidyverse revolution. [@ggplot]

## DeSolve library

R package deSolve is the successor of R package odesolve, which is a package to solve initial value problems (IVP) of ordinary differential equations (ODE), differential algebraic equations (DAE), partial differential equations (PDE), and delay differential equations (DeDE). I used this package to solve the systems of nonlinear differential equations present in predator-prey models.  
The particular function I used for the solutions is the *lsoda* function   

[@link].

## Possible source of errors

When integrating differential equations one must always take the step-error into account. Derivatives require small differences which are prone to subtractive cancelations and round-off error accumulation. When I solve the simplest LV model, one can observe that the limit cycles do not form closed curves, which is due to the errors mentioned before.  
Also I tried to set the time intervals big enough to see meaningfull information on the plots and I used an appropriate resolution on these intervals to avoid further errors.  


# Classical LV model

This model describes the interaction of a predatory and a prey species. The predators try to catch the preys, thus increasing their population, and decreasing the prey’s. In this model the prey species has unlimited resources to feed, and in this way the population of the prey species grows exponentially if no predatory species are present. We can summarize the whole model in a system of nonlinear differential equations:
$$
\frac{dX}{dt}= aX-bXY
$$
$$
\frac{dY}{dt}= bkXY-lY
$$
where *x* and *y* are the prey and predator density, respectively, *a* and *l* determines how fast the preys reproduce and the predators die of hunger. *b* and *k* describes the interaction part of the equation, where *b* governs the interaction rate between the two species, and *k* is set the efficiency of which the predators converts prey to food.


```{r, echo=FALSE, warning=FALSE, message=FALSE}
library(deSolve)
library(ggplot2)
library(reshape2)
library(gridExtra)
library(knitr)
library(captioner)



model_system <- function(model, Pars, State, grouped){
  out <- as.data.frame(ode(func = model, y = State, parms = Pars, times = Time))
  out.r <- within(out, rm(time))
  out.m <- melt(out.r)
  out.m$time <- out$time
  if (grouped == TRUE){
  return(out.m)
  }
  else{
    return(out)
  }
}

LotVmod_classical <- function (Time, State, Pars) {
    with(as.list(c(State, Pars)), {
        dx = x*(alpha - beta*y)
        dy = delta*x*y - gamma*y
        return(list(c(dx, dy)))
    })
}
 
Pars <- c(alpha = 0.1, beta = 0.02, gamma = 0.4, delta = 0.02)
State <- c(x = 10, y = 10)
Time <- seq(0, 200, by = 0.1)
 
out.m <- model_system(LotVmod_classical, c(alpha = 0.1, beta = 0.02, gamma = 0.4, delta = 0.02), 
                      c(x = 10, y = 10), TRUE)
out1 <- model_system(LotVmod_classical, c(alpha = 0.1, beta = 0.02, gamma = 0.4, delta = 0.02), 
                      c(x = 10, y = 10), FALSE)
out2 <- model_system(LotVmod_classical, c(alpha = 0.1, beta = 0.02, gamma = 0.4, delta = 0.02), 
                      c(x = 50, y = 10), FALSE)
out3 <- model_system(LotVmod_classical, c(alpha = 0.1, beta = 0.02, gamma = 0.4, delta = 0.02), 
                      c(x = 200, y = 10), FALSE)

out1$preystart <- 10
out2$preystart <- 50
out3$preystart <- 200


out.final <- rbind(out1,out2,out3)
out.final$preystart <- as.factor(out.final$preystart)
out.m$variable <- as.character(out.m$variable)
out.m$variable[out.m$variable == "x"] <- "Prey"
out.m$variable[out.m$variable == "y"] <- "Predator"

p1<-ggplot(out.m, aes(x=time, y=value, color=variable)) +
  geom_line(aes(color=variable), size = 1)+
  
  labs(x = "Time",
       y = "Species density",
       color = "Species",
       title = "Figure 1. Time evolution of the prey and predator densities") +
   theme(plot.title = element_text(size=6)) + theme(legend.position="bottom",legend.direction="horizontal")


p2<-ggplot(out.final, aes(x=x, y=y, color = preystart))+
  geom_point(aes(color=preystart), size = 0.05)+ 
  labs(x = "Prey density",
       y = "Predator density",
       color = "Prey initial number",
       title = paste("Figure 2. Phase space of prey and predator densities,", '\n', "with different prey initial density values"))  +
   theme(plot.title = element_text(size=6)) + theme(legend.position="bottom",legend.direction="horizontal")



params1 <- data.frame(parameter = c("a", "b", "k", "l", "X0", "Y0"), value =
                        c(0.1,0.2,0.02,0.4, 10,10))


```

```{r,echo=FALSE, warning=FALSE, message=FALSE}
grid.arrange(p1, p2, ncol=2)
```


```{r, echo=FALSE, warning=FALSE, message=FALSE}

kable(params1, caption = "Parameter values for the simplest LV model")
```

  
One can show that there exists a non-trivial stable solution to this model by setting the followings:  

$$
\dot{x} = 0
$$
and
$$
\dot{y} = 0
$$
gives 
$$
x_{0} = \frac{l}{bk}, y_{0} = \frac{a}{b}
$$
which results in a stable equilibrium solution.
Starting the simulation with these initial values gives us a non-trivial, stable state.
```{r, echo=FALSE, warning=FALSE, message=FALSE}
out.m <- model_system(LotVmod_classical, c(alpha = 0.1, beta = 0.02, gamma = 0.4, delta = 0.02), 
                      c(x = 20, y = 5), TRUE)
out <- model_system(LotVmod_classical, c(alpha = 0.1, beta = 0.02, gamma = 0.4, delta = 0.02), 
                      c(x = 20, y = 5), FALSE)

out.m$variable <- as.character(out.m$variable)
out.m$variable[out.m$variable == "x"] <- "Prey"
out.m$variable[out.m$variable == "y"] <- "Predator"
names(out.m) <- c("Species", "value", "time")

p3<-ggplot(out.m, aes(x=time, y=value, group=Species)) +
  geom_line(aes(color=Species), size = 1)+
  
  labs(x = "Time",
       y = "Species density",
       title = paste("Figure 3. Time evolution of the prey,",'\n', "and predator densities in the steady state"))+ theme(legend.position="bottom",legend.direction="horizontal")+
   theme(plot.title = element_text(size=6))

p4<-ggplot(out, aes(x=x, y=y))+
  geom_point()+ 
  labs(x = "Prey density",
       y = "Predator density",
       title = "Figure 4. Phase space of prey and predator densities in the steady state") + theme(legend.position="bottom",legend.direction="horizontal")+
   theme(plot.title = element_text(size=6))


#grid.arrange(p3, p4, ncol=2)

params2 <- data.frame(parameter = c("a", "b", "k", "l", "X0", "Y0"), values =
                        c(0.1,0.02,0.02, 0.4,20,5))
#kable(params2)
```

```{r,echo=FALSE, warning=FALSE, message=FALSE}
grid.arrange(p3, p4, ncol=2)
```


```{r, echo=FALSE, warning=FALSE, message=FALSE}

kable(params2, caption = "Parameter values for the simplest LV model in equilibrium")
```

## Discussion  

On plot1 one can see that the solution of this model is an oscillatory behavior, where the prey and predator density rise and fall out of phase respect to each other.Plotting the x,y phase space on plot2 shows closed orbits, called limit cycles. However, the orbits are not perfectly closed due to the errors in the numerical integration of the equations.


# LV model with prey limit and predator efficiency

This model extends the classical LV model in such a way, that it includes a so called K carrying capacity for the prey population, and a functional response palpha, as the probability a predator finds one prey. These two parameters makes the model more realistic, as in reality the resources available for the preys are not unlimited, and the hunt by the predators are not always successful, and takes time. 
$$
\frac{dX}{dt} = Xa(1-\frac{X}{K}) - \frac{bYX}{1+bX\tau}
$$
$$
\frac{dY}{dt}= bkXY-lY
$$

```{r, echo=FALSE, warning=FALSE, message=FALSE}
LotVmod_version2 <- function (Time, State, Pars) {
    with(as.list(c(State, Pars)), {
        dx = x*alpha*(1-x/K) - (beta*y*x)/(1+beta*x*tau)
        dy = delta*x*y - gamma*y
        return(list(c(dx, dy)))
    })
}
 

Time <- seq(0, 500, by = 0.1)
 
out.m <- model_system(LotVmod_version2, c(alpha = 0.1, beta = 0.02, gamma = 0.4, delta = 0.02, K = 100, tau = 0.3), 
                      c(x = 10, y = 10), TRUE)
out <- model_system(LotVmod_version2, c(alpha = 0.1, beta = 0.02, gamma = 0.4, delta = 0.02, K = 100, tau = 0.3), 
                      c(x = 10, y = 10), FALSE)

out.m$variable <- as.character(out.m$variable)
out.m$variable[out.m$variable == "x"] <- "Prey"
out.m$variable[out.m$variable == "y"] <- "Predator"

p1<-ggplot(out.m, aes(x=time, y=value, color=variable)) +
  geom_line(aes(color=variable), size = 1)+
  
  labs(x = "Time",
       y = "Species density",
       color = "Species",
       title = paste("Figure 5. Time evolution of the prey and predator", '\n', "densities, as prey limit and predatory efficiency are included")) +
   theme(plot.title = element_text(size=7)) + theme(legend.position="bottom",legend.direction="horizontal")


p2<-ggplot(out, aes(x=x, y=y))+
  geom_point(aes(color='red'), size = 0.05)+ 
  labs(x = "Prey density",
       y = "Predator density",
       color = "Prey initial number",
       title = paste("Figure 6. Phase space of prey and predator densities"))  +
   theme(plot.title = element_text(size=7)) + theme(legend.position="none",legend.direction="horizontal")

grid.arrange(p1, p2, ncol=2)
params3 <- data.frame(parameter = c("a", "b", "k", "l", "K","tau","X0", "Y0"), values =
                        c(0.1,0.02,0.4,0.02,100,0.3,10,10))

```
```{r, echo=FALSE, warning=FALSE, message=FALSE}
kable(params3, caption = "Parameter values for the LV model with prey limit and predatory efficiency")
```


## Discussion

# Two preys, one predator LV model

This modification of the original LV model includes the extensions mentioned above, and also includes one more prey species. In reality there can be preys which can be hunted down more easily by the predator, and could have different carrying capacity. These biological information are included in the parameters of this model. 

$$
\frac{dX_{1}}{dt} = Xa_{1}(1-\frac{X_{1}}{K_{1}}) - \frac{b_{1}YX_{1}}{1+b_{1}X_{1}\tau_{1}}
$$
$$
\frac{dX_{2}}{dt} = Xa_{2}(1-\frac{X_{2}}{K_{2}}) - \frac{b_{2}YX_{2}}{1+b_{2}X_{2}\tau_{2}}
$$

$$
\frac{dY}{dt}= \delta X_{1}Y + \delta X_{2}Y-lY
$$


```{r, echo=FALSE, warning=FALSE, message=FALSE}
LotVmod_twoprey <- function (Time, State, Pars) {
    with(as.list(c(State, Pars)), {
        
        dx1 = x1*alpha1*(1-x1/K1) - (beta1*y*x1)/(1+beta1*x1*tau1) 
        dx2 = x2*alpha2*(1-x2/K2) - (beta2*y*x2)/(1+beta2*x2*tau2)
        dy = delta1*x1*y + delta2*x2*y - gamma*y
        return(list(c(dx1,dx2 ,dy)))
    })
}
 

Time <- seq(0, 500, by = 0.1)
 
out.m <- model_system(LotVmod_twoprey, c(alpha1 = 0.1, beta1 = 0.02, gamma = 0.4, delta1 = 0.02, K1 = 100, tau1 = 0.3,alpha2 = 0.15, beta2 = 0.02, K2 = 100, tau2 = 0.3, delta2 = 0.02, sigma1 = 0.01, sigma2 = 0.01), 
                      c(x1 = 30,x2 = 10 ,y = 10), TRUE)
out <- model_system(LotVmod_twoprey, c(alpha1 = 0.1, beta1 = 0.02, gamma = 0.4, delta1 = 0.02, K1 = 100, tau1 = 0.3,alpha2 = 0.15, beta2 = 0.02, K2 = 100, tau2 = 0.3, delta2 = 0.02, sigma1 = 0.01, sigma2 = 0.01), 
                      c(x1 = 30,x2 = 10 ,y = 10), FALSE)

out.m$variable <- as.character(out.m$variable)
out.m$variable[out.m$variable == "x1"] <- "Prey1"
out.m$variable[out.m$variable == "x2"] <- "Prey2"
out.m$variable[out.m$variable == "y"] <- "Predator"

p1<-ggplot(out.m, aes(x=time, y=value, group=variable)) +
  geom_line(aes(color=variable), size = 1)+

  labs(x = "Time",
       y = "Species density",
       title = "Figure 7. Time evolution of the prey and predator densities in the two-prey, one predator model") +
   theme(plot.title = element_text(size=7)) 

p1

p2<-ggplot(out, aes(x=x, y=y))+
  geom_point(aes(color="red"))+ 
  labs(x = "Prey density",
       y = "Predator density",
       title = "Phase space of prey and predator densities")
#p2
params4 <- data.frame(parameter = c("a1", "a2", "b1", "b2", "K1","K2","tau1","tau2","l","delta1","delta2","X1_0","X2_0","Y0"), values =
                        c(0.1,0.15,0.02,0.02,100,100,0.3,
                          0.3,0.4, 0.02, 0.02, 30,10,10))

```
```{r, echo=FALSE, warning=FALSE, message=FALSE}
kable(params4, caption = "Parameter values for the two-prey, one predator model")
```


## Discussion

# Stock market application

Within recent times, application of models which originate from biology have become used in finance to describe the complex behavior of the stock market. There are multiple approaches [@GHEZZI1992371] which tries to apply the slightly modified version of the predator-prey models to analyze how venture capital investments exhaust the available stock of opportunities. A trader would be likely to make a more informed choice between competing stocks or shares based on comparisons among prices per share.  
In the model described in this chapter the financially powerful trading company who wants to acquire smaller, financially weak companies, is the predator, while the smaller companies represent the prey. The predator makes a monetary offer for the prey shares. Once purchased, these shares are held until they are converted to predator shares.  
The main objective is to simulate the system described above, and to make profit from the price changes.  
In order for this to be profitable financially, the predator needs to have an
estimate of the risk involved in this trade and this is based on changes in his
predatory share prices.  
Analyzing the simulation results can allow the trader to find the specific parameters which makes the system stable, and this would allow determine if the acquistion of prey company shares is profitable, or not.  
$$
\frac{X_{1}}{dt} = \alpha_{1}X_{1}\left ( 1-\frac{X_{1}}{K_{1}} \right )-m_{12}X_{1}X_{2} - \beta X_{1}Yr_{1}
$$

$$
\frac{X_{2}}{dt} = \alpha_{2}X_{2}\left ( 1-\frac{X_{2}}{K_{2}} \right )-m_{21}X_{1}X_{2} - \beta X_{2}Yr_{2}
$$

$$
\frac{dY}{dt} = -\mu Y + c_{1}\beta_{1}X_{1}Yr_{1} + c_{2}\beta_{2}X_{2}Yr_{2}
$$

$$
r1 = \frac{1}{1+\left ( \frac{a_{2}X_{2}+b_{2}Y}{X_{1}} \right )^{n}}
$$

$$
r2 = \frac{1}{1+\left ( \frac{a_{1}X_{1}+b_{1}Y}{X_{2}} \right )^{n}}
$$

* *X1* and *X2* are relative share prices of competing prey companies, *Y* is the relative price per share of the predator company. The parameters used in the model are all non-negative.  
* *alpha1* and *alpha2*: Intrinsic growth rate of prey share price,  
* *K1* and *K2*: Carrying capacity of prey shares,  
* *m12* and *m21*: Inter-specific competition between prey market shares,  
* *beta1* and *beta2*: Predatory capture rate  is the probability predator Y invests in prey X1 or X2,  
* *a1* and *a2*: Harvesting rate of prey shares,  
* *b1* and *b2*: Anti-predator behavior of prey shares,  
* *c1* and *c2*: Rate of conversion of prey shares to predator shares,  
* *mu*: Rate of decline of predator share price,  
* *n* : Multiplicative effect due to the predatory functional response.  





```{r, echo=FALSE, warning=FALSE, message=FALSE}
LotVmod_stock <- function (Time, State, Pars) {
    with(as.list(c(State, Pars)), {
        r1 = 1/((1+(a2*x2+b2*y)/x1)^n)
        r2 = 1/((1+(a1*x1+b1*y)/x2)^n)
        dx1 = x1*alpha1*(1-x1/K1) - m12*x1*x2 - (beta1*y*x1)*r1
        dx2 = x2*alpha2*(1-x2/K2) - m21*x1*x2 -(beta2*y*x2)*r2
        dy = -mu*y + c1*beta1*x1*y*r1 + c2*beta2*x2*y*r2
        return(list(c(dx1,dx2 ,dy)))
    })
}
 

Time <- seq(0, 20000, by = 100)
 
out.m.stable <- model_system(LotVmod_stock, c(alpha1 = 0.04, alpha2 = 0.05,
                      K1 = 5, K2 = 10, m12 = 0.01, m21 = 0.02,beta1 = 0.03, beta2 = 0.03,
                      mu = 0.02, c1 = 0.1, c2 = 0.2, n = 1, a1 = 0.02, a2 =1.5, b1 = 0.01, b2=0.03),c(x1 = 0.5644,x2 = 3.3233 ,y =  0.7406), TRUE)

out.m.unstable <- model_system(LotVmod_stock, c(alpha1 = 0.04, alpha2 = 0.05,
                      K1 = 5, K2 = 10, m12 = 0.01, m21 = 0.02,beta1 = 0.03, beta2 = 0.03,
                      mu = 0.02, c1 = 0.1, c2 = 0.2, n = 1, a1 = 0.02, a2 =3.5, b1 = 0.01, b2=0.03),c(x1 = 0.5644,x2 = 3.3233 ,y =  0.7406), TRUE)


out.stable <- model_system(LotVmod_stock, c(alpha1 = 0.04, alpha2 = 0.05,
                      K1 = 5, K2 = 10, m12 = 0.01, m21 = 0.02,beta1 = 0.03, beta2 = 0.03,
                      mu = 0.02, c1 = 0.1, c2 = 0.2, n = 1, a1 = 0.02, a2 =1.5, b1 = 0.01, b2=0.03),c(x1 = 0.5644,x2 = 3.3233 ,y =  0.7406), FALSE)

out.m.stable$variable <- as.character(out.m.stable$variable)
out.m.stable$variable[out.m.stable$variable == "x1"] <- "Prey1"
out.m.stable$variable[out.m.stable$variable == "x2"] <- "Prey2"
out.m.stable$variable[out.m.stable$variable == "y"] <- "Predator"

out.m.unstable$variable <- as.character(out.m.unstable$variable)
out.m.unstable$variable[out.m.unstable$variable == "x1"] <- "Prey1"
out.m.unstable$variable[out.m.unstable$variable == "x2"] <- "Prey2"
out.m.unstable$variable[out.m.unstable$variable == "y"] <- "Predator"

p1<-ggplot(out.m.stable, aes(x=time, y=value, group=variable)) +
  geom_line(aes(color=variable), size = 1)+
  labs(x = "Time",
       y = "Relative price per share",
       title = paste("Figure 8. Time evolution of the relative share price of the ",'\n',"prey and predator companies in equilibrium")) +
   theme(plot.title = element_text(size=8)) 

p2<-ggplot(out.m.unstable, aes(x=time, y=value, group=variable)) +
  geom_line(aes(color=variable), size = 1)+
  labs(x = "Time",
       y = "Relative price per share",
       title = paste("Figure 9. Time evolution of the relative share price of the ",'\n',"prey and predator companies in an unstable state")) +
   theme(plot.title = element_text(size=8)) 


params4 <- data.frame(parameter = c("a1", "a2", "b1", "b2","alpha1","alpha2","beta1","beta2", "K1","K2","m12","m21","mu","n","c1","c2","X1_0","X2_0","Y0"), values =
                        c(0.02,1.5, 0.01,0.03,0.04, 0.05, 0.03,                         0.03,5,10,0.01,0.02,0.02,1,0.1,0.2,0.5644,3.3233,0.7406))
grid.arrange(p1, p2, nrow=2)

kable(params4)
```

## Discussion

### Meaning of the parameters and the stability in the financial world  

The *a1*, *a2*, *b1*, *b2* parametes represents the predatory functions, and in more detail the harvesting rate and the anti-predatory behavior of the preys.
These represent the harvesting rate of prey and anti-predator behavior of prey respectively. In the financial world, these are taken to be the equity risk premium (excess returns based on investment in the stock market) and price volatility index (a measure of risk in terms of ‘investor fear’ in the stock market) respectively from the two prey stocks.
The parameters *c1* and *c2*, which naturally represents in biology the conversion rates of the i-th prey to predator are represented financially as the price to earnings ratio of the prey stock respectively.

Therefore, a predator company who wishes to invest in either of these companies can be advised that if the stock parameters of those companies are kept within the stability intervals, their investment would be stable and profitable. Otherwise, parameters outside of these intervals would cause the model to become unstable and therefore it would not be wise to invest.


# Summary

What I did

The stock market also has equilibrium, so it behaves like an ecosystem and
understanding the ramifications of these mechanisms can provide the investor
with insights that yield competitive advantages [4].

# References